// This file was generated by SquareLine Studio
// SquareLine Studio version: SquareLine Studio 1.3.4
// LVGL version: 8.3.6
// Project name: SquareLine_Project

#include "ui.h"
#include "totp-map.h"
#include "esp_log.h"
#include <time.h>
#include "constants.h"

extern int setup_complete;
extern uint32_t LV_EVENT_SETUP_COMPLETE;

int calculate_new_bar_value(){
    struct tm *timeinfo; 
    time_t now;
    time(&now); 
    timeinfo = localtime(&now); 
    int val = TOTP_PERIOD - timeinfo->tm_sec % TOTP_PERIOD; 
    return val;
}

void on_totp_component_label_value_changed(lv_event_t *e) {
    LV_LOG_TRACE("on_totp_component_label_value_changed");
    lv_obj_t *label = lv_event_get_target(e);
    TotpValueChangeEvent * data = (TotpValueChangeEvent *)lv_event_get_param(e);
    char *totp = get_totp_by_index(data->index);

    LV_LOG_TRACE("totp: %s index: %d", totp, data->index);
    // NOTE: a copy of the value stored at *totp (ref) is created so that it can be dealocated or changed without compromising what is currently being displayed
    char *temp = strdup(totp);
    if(temp){
        lv_label_set_text(label, temp);
        free(temp);
    }
}

void on_totp_component_bar_value_changed(lv_event_t *e){
    LV_LOG_TRACE("on_totp_component_bar_value_changed");
    lv_obj_t *bar = lv_event_get_target(e);
    int val = calculate_new_bar_value();
    lv_bar_set_value(bar, val, LV_ANIM_OFF);
}
